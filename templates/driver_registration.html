{% extends 'base.html' %}

{% block title %}Driver Registration - TicketNow PH{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>üöó Driver Registration</h2>
        <p class="text-muted">Register a new driver with Philippine license information</p>
        
        <form method="post" class="mt-4">
            {% csrf_token %}
            
            <!-- Personal Information -->
            <div class="form-section border rounded p-3 mb-4 shadow-sm bg-light">
                <h5>Personal Information</h5>
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label required-field">First Name</label>
                            {{ form.first_name }}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Middle Name</label>
                            {{ form.middle_name }}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label required-field">Last Name</label>
                            {{ form.last_name }}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Suffix</label>
                            {{ form.suffix }}
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label required-field">Birth Date</label>
                            {{ form.birth_date }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label required-field">Birth Place</label>
                            {{ form.birth_place }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label required-field">Blood Type</label>
                            {{ form.blood_type }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact Information -->
            <div class="form-section border rounded p-3 mb-4 shadow-sm bg-light">
                <h5>Contact Information</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required-field">Mobile Number</label>
                            {{ form.mobile_number }}
                            <small class="form-text text-muted">Format: +639171234567 or 09171234567</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required-field">Email Address</label>
                            {{ form.email }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Address Information -->
            <div class="form-section border rounded p-3 mb-4 shadow-sm bg-light">
                <h5>Address Information</h5>
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label required-field">House/Bldg No.</label>
                            {{ form.house_number }}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label required-field">Street</label>
                            {{ form.street }}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label required-field">Barangay</label>
                            {{ form.barangay }}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label required-field">ZIP Code</label>
                            {{ form.zip_code }}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required-field">City/Municipality</label>
                            {{ form.city_municipality }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label required-field">Province</label>
                            {{ form.province }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Driver's License Information -->
            <div class="form-section border rounded p-3 mb-4 shadow-sm bg-light">
                <h5>Driver's License Information</h5>
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label required-field">License Number</label>
                            {{ form.license_number }}
                            <small class="form-text text-muted">Format: N01-23-456789</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label required-field">License Expiry</label>
                            {{ form.license_expiry }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label required-field">License Type</label>
                            {{ form.license_type }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Emergency Contact -->
            <div class="form-section border rounded p-3 mb-4 shadow-sm bg-light">
                <h5>Emergency Contact</h5>
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label required-field">Contact Name</label>
                            {{ form.emergency_contact_name }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label required-field">Contact Number</label>
                            {{ form.emergency_contact_number }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label required-field">Relationship</label>
                            {{ form.emergency_contact_relationship }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit -->
            <hr>
            <h5>üìù Final Step: Submit Registration</h5>
            <div class="mt-4">
                <button type="submit" class="btn btn-primary btn-lg">Register Driver</button>
                <a href="{% url 'home' %}" class="btn btn-secondary btn-lg">Cancel</a>
            </div>
        </form>
    </div>
</div>

<hr>
<h5>üì∏ Driver‚Äôs License OCR Scanner</h5>
<p class="text-muted">Capture a clear photo of the driver's license for automatic data extraction.</p>

<div id="cameraContainer">
  <video id="cameraFeed" width="400" autoplay playsinline></video><br>
  <button type="button" id="captureBtn" class="btn btn-primary mt-2">Capture License</button>
  <button type="button" id="closeCameraBtn" class="btn btn-danger mt-2">Close Camera</button>
  <canvas id="canvas" style="display:none;"></canvas>
  <img id="capturedImage" class="mt-3 border rounded" width="400" style="display:none;">
</div>

<button type="button" id="openCameraBtn" class="btn btn-success mt-3">Open Camera</button>

<script>
const openCameraBtn = document.getElementById('openCameraBtn');
const closeCameraBtn = document.getElementById('closeCameraBtn');
const captureBtn = document.getElementById('captureBtn');
const video = document.getElementById('cameraFeed');
const canvas = document.getElementById('canvas');
const capturedImage = document.getElementById('capturedImage');
let stream;

openCameraBtn.addEventListener('click', async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
  } catch (err) {
    alert('Camera access denied or unavailable.');
  }
});

closeCameraBtn.addEventListener('click', () => {
  if (stream) stream.getTracks().forEach(track => track.stop());
  video.srcObject = null;
});

captureBtn.addEventListener('click', async () => {
  const context = canvas.getContext('2d');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  context.drawImage(video, 0, 0, canvas.width, canvas.height);
  const imageData = canvas.toDataURL('image/png');

  capturedImage.src = imageData;
  capturedImage.style.display = 'block';

  // Send to Django backend
  const response = await fetch('/vehicles/ocr-process/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}',
    },
    body: JSON.stringify({ image_data: imageData })
  });

  const data = await response.json();

  if (data.error) {
    alert('‚ùå OCR Error: ' + data.error);
  } else {
    alert('‚úÖ License scanned successfully! Filling details...');
    for (const [key, value] of Object.entries(data)) {
      const input = document.getElementById('id_' + key);
      if (input && value) input.value = value;
    }
  }
});
</script>

{% endblock %}
