{% extends 'base.html' %}
{% load static %}
{% block title %}Deposit Analytics | TicketNow{% endblock %}

{% block content %}
<div class="container-fluid p-4">

  <!-- ðŸ§­ Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="fw-bold text-primary mb-1">
        <i class="bi bi-graph-up-arrow"></i> Deposit Analytics
      </h3>
      <p class="text-muted mb-0">
        Visual overview of driver deposits â€” track daily trends and top contributors.
      </p>
    </div>
  </div>

  <!-- ðŸ’° Summary Card -->
  <div class="row text-center mb-4">
    <div class="col-md-4 offset-md-4">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <h6 class="text-muted mb-1 text-uppercase">Total Deposits (Last 7 Days)</h6>
          <h2 class="fw-bold text-primary mb-0">â‚±{{ total_deposits|floatformat:2 }}</h2>
        </div>
      </div>
    </div>
  </div>

  <!-- ðŸ“ˆ Chart -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
      <h5 class="card-title mb-3">
        <i class="bi bi-bar-chart text-primary"></i> 7-Day Deposit Trend
      </h5>
      <canvas id="depositChart" height="110"></canvas>
    </div>
  </div>

  <!-- ðŸš— Top Vehicles -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
      <h5 class="card-title mb-3">
        <i class="bi bi-trophy text-warning"></i> Top 5 Vehicles by Total Deposit
      </h5>

      {% if top_vehicles %}
      <div class="table-responsive">
        <table class="table table-striped align-middle mb-0">
          <thead class="table-primary">
            <tr>
              <th>#</th>
              <th>Vehicle Plate</th>
              <th>Total Deposited (â‚±)</th>
            </tr>
          </thead>
          <tbody>
            {% for v in top_vehicles %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td class="fw-semibold">{{ v.wallet__vehicle__license_plate }}</td>
              <td class="fw-bold text-success">â‚±{{ v.total|floatformat:2 }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <p class="text-muted text-center my-3">
          <i class="bi bi-info-circle"></i> No deposit data found in the past 7 days.
        </p>
      {% endif %}
    </div>
  </div>

  <!-- â„¹ï¸ Info Note -->
  <div class="alert alert-info shadow-sm">
    <i class="bi bi-info-circle me-2"></i>
    This report helps track daily deposit activity and identify the most active drivers.
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const ctx = document.getElementById('depositChart');
  if (!ctx) return;

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: {{ labels|safe }},
      datasets: [{
        label: 'Daily Total (â‚±)',
        data: {{ daily_totals|safe }},
        backgroundColor: 'rgba(13,110,253,0.6)',
        borderColor: '#0d6efd',
        borderWidth: 2,
        borderRadius: 6,
        hoverBackgroundColor: 'rgba(13,110,253,0.8)',
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#000',
          titleColor: '#fff',
          bodyColor: '#fff'
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: { font: { size: 14 } }
        },
        y: {
          beginAtZero: true,
          ticks: {
            callback: val => 'â‚±' + val.toLocaleString(),
            font: { size: 14 }
          }
        }
      }
    }
  });
});
</script>
{% endblock %}
