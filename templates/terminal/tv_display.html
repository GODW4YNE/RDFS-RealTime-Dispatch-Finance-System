{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Terminal TV Display | TicketNow</title>

  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background: #f8f9fa;
      font-family: 'Segoe UI', sans-serif;
      overflow-x: hidden;
      font-size: 1.4rem;
    }
    .header {
      background: linear-gradient(90deg, #0d6efd, #0dcaf0);
      color: white;
      padding: 1.5rem;
      text-align: center;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      position: relative;
    }
    .header h2 {
      font-weight: 800;
      font-size: 2.2rem;
      margin-bottom: 0.3rem;
    }
    .sub-header {
      font-size: 1.3rem;
      font-weight: 500;
      color: #e2f0ff;
    }
    .clock {
      font-size: 1.4rem;
      font-weight: 600;
      color: #f8f9fa;
    }
    .btn-back, .btn-fullscreen {
      position: absolute;
      top: 25px;
      background: white;
      border: none;
      color: #0d6efd;
      font-weight: 700;
      border-radius: 10px;
      padding: 10px 20px;
      font-size: 1.1rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
      transition: all 0.2s ease-in-out;
    }
    .btn-back {
      left: 25px;
    }
    .btn-fullscreen {
      right: 25px;
    }
    .btn-back:hover, .btn-fullscreen:hover {
      background: #0d6efd;
      color: white;
      transform: scale(1.05);
    }
    .route-section {
      border-radius: 10px;
      padding: 1.2rem;
      margin-top: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .route-header {
      font-weight: 800;
      font-size: 1.7rem;
      padding: 10px 18px;
      border-radius: 5px;
      margin-bottom: 0.6rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .route-header span {
      font-size: 1.3rem;
      font-weight: 600;
      color: #444;
    }
    .table {
      background: white;
      border-radius: 12px;
      font-size: 1.4rem;
      margin-top: 1rem;
    }
    thead th {
      background: #0d6efd;
      color: white;
      text-align: center;
      font-size: 1.2rem;
      padding: 0.8rem;
    }
    tbody td {
      text-align: center;
      vertical-align: middle;
      font-weight: 500;
      padding: 1rem;
    }
    .status-badge {
      font-size: 1.2rem;
      padding: 6px 12px;
      border-radius: 25px;
      font-weight: 700;
      min-width: 150px;
      display: inline-block;
    }
    .progress {
      height: 10px;
      border-radius: 5px;
      background-color: #e9ecef;
      overflow: hidden;
      margin-top: 6px;
    }
    .progress-bar {
      height: 100%;
      transition: width 1s linear;
    }
    .progress-bar.glow {
      box-shadow: 0 0 10px 3px rgba(220, 53, 69, 0.7);
    }
    .route-select {
      width: 280px;
      font-size: 1.1rem;
      border-radius: 8px;
      border: 2px solid #0dcaf0;
      padding: 8px;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <!-- ðŸŸ¦ Header -->
  <div class="header">
    <h2><i class="bi bi-display"></i> Terminal Queue Board</h2>
    <div class="sub-header">
      {% if selected_route != "All Routes" %}
        <i class="bi bi-signpost-2"></i> {{ selected_route }} Display Board
      {% else %}
        <i class="bi bi-globe"></i> All Routes Display Board
      {% endif %}
    </div>
    <div id="live-clock" class="clock"></div>

    <button onclick="window.location.href='{% url 'accounts:staff_dashboard' %}'" class="btn-back">
      <i class="bi bi-arrow-left"></i> Back
    </button>

    <button id="fullscreenBtn" class="btn-fullscreen">
      <i class="bi bi-arrows-fullscreen"></i> Fullscreen
    </button>
  </div>

  <!-- ðŸŸ© Route Filter -->
  <div class="text-center mt-4">
    <select id="routeSelector" class="route-select" onchange="filterRoute(this.value)">
      <option value="">All Routes</option>
      {% for route in all_routes %}
        <option value="{{ route.name|slugify }}" {% if route.name == selected_route %}selected{% endif %}>
          {{ route.name }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="container-fluid mt-4 px-5" id="route-container">
    {% if grouped_routes %}
      {% for route_name, vehicles in grouped_routes.items %}
      <div class="route-section" data-route="{{ route_name }}">
        <div class="route-header">
          {{ route_name }}
          <span>{{ vehicles|length }} active vehicle{{ vehicles|length|pluralize }}</span>
        </div>
        <div class="table-responsive">
          <table class="table table-bordered align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>Plate No.</th>
                <th>Driver</th>
                <th>Entry Time</th>
                <th>Departure Status</th>
              </tr>
            </thead>
            <tbody>
              {% for v in vehicles %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td><strong>{{ v.plate }}</strong></td>
                <td>{{ v.driver }}</td>
                <td>{{ v.entry_time }}</td>
                <td>
                  <div>
                    <span class="status-badge bg-info text-dark countdown"
                          data-departure="{{ v.departure_time|date:'c' }}">Loading...</span>
                    <div class="progress mt-2">
                      <div class="progress-bar" role="progressbar"></div>
                    </div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="alert alert-secondary text-center mt-4 fs-4">
        <i class="bi bi-info-circle"></i> No active vehicles in any route.
      </div>
    {% endif %}
  </div>

  <script>
  // ðŸ•’ Live clock
  function updateClock() {
    const now = new Date();
    document.getElementById('live-clock').textContent =
      "ðŸ•’ " + now.toLocaleTimeString('en-US', { hour12: true });
  }
  setInterval(updateClock, 1000);
  updateClock();

  // ðŸŸ© Route filter
  function filterRoute(slug) {
    const base = window.location.origin + "{% url 'terminal:tv_display' %}";
    if (slug) window.location.href = base + slug + "/";
    else window.location.href = base;
  }

  // ðŸŽ¨ Route section background tint
  function applyRouteColors() {
    document.querySelectorAll(".route-section").forEach(section => {
      const name = section.dataset.route || "default";
      let hash = 0;
      for (let i = 0; i < name.length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
      }
      const hue = hash % 360;
      section.style.backgroundColor = `hsl(${hue}, 75%, 95%)`;
      section.querySelector(".route-header").style.backgroundColor = `hsl(${hue}, 85%, 90%)`;
    });
  }

  // â³ Countdown + progress bar
  function updateCountdowns() {
    const now = new Date().getTime();
    const threshold = 15 * 60 * 1000;
    document.querySelectorAll('.countdown').forEach(span => {
      const departure = new Date(span.dataset.departure).getTime();
      const diff = departure - now;
      const bar = span.closest('td').querySelector('.progress-bar');
      if (!bar) return;

      if (diff <= 0) {
        span.textContent = "ðŸš Departed";
        span.className = "status-badge bg-danger text-white";
        bar.style.width = "100%";
        bar.style.backgroundColor = "#dc3545";
        bar.classList.add('glow');
      } else if (diff <= threshold) {
        const mins = Math.floor(diff / (1000 * 60));
        span.textContent = mins <= 0 ? "ðŸš Departing now!" : `â³ Leaving in ${mins} min`;
        const progress = 100 - (diff / threshold) * 100;
        bar.style.width = progress + "%";
        if (progress < 50) bar.style.backgroundColor = "#0d6efd";
        else if (progress < 80) bar.style.backgroundColor = "#fd7e14";
        else {
          bar.style.backgroundColor = "#dc3545";
          bar.classList.add('glow');
        }
      } else {
        span.textContent = "ðŸŸ© Boarding";
        span.className = "status-badge bg-success text-white";
        bar.style.width = "0%";
        bar.style.backgroundColor = "#0d6efd";
        bar.classList.remove('glow');
      }
    });
  }

  updateCountdowns();
  applyRouteColors();
  setInterval(updateCountdowns, 5000);

  // ðŸ” Auto-refresh every 10 seconds
  setInterval(() => {
    fetch(window.location.href)
      .then(r => r.text())
      .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newContainer = doc.getElementById('route-container');
        if (newContainer) {
          document.getElementById('route-container').innerHTML = newContainer.innerHTML;
          applyRouteColors();
        }
      })
      .catch(err => console.error('Refresh error:', err));
  }, 10000);

  // ðŸ–¥ï¸ Fullscreen toggle
  const fsBtn = document.getElementById("fullscreenBtn");
  fsBtn.addEventListener("click", () => {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen();
      fsBtn.innerHTML = '<i class="bi bi-fullscreen-exit"></i> Exit Fullscreen';
    } else {
      document.exitFullscreen();
      fsBtn.innerHTML = '<i class="bi bi-arrows-fullscreen"></i> Fullscreen';
    }
  });
  </script>
</body>
</html>
