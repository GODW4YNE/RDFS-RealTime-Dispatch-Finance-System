{% extends 'base.html' %}
{% load static %}

{% block title %}QR Scan Entry{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="card shadow-sm border-0">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0"><i class="bi bi-qr-code-scan me-2"></i>QR Scan Entry Validation</h5>
    </div>

    <div class="card-body text-center">
      <p class="text-muted mb-3">
        Use your camera to scan a vehicle‚Äôs QR code for entry validation.
      </p>

      <!-- üü© QR Scanner (html5-qrcode) -->
      <div id="qr-reader" style="width:100%; max-width:400px; margin:auto;"></div>

      <!-- ‚úÖ Live feedback -->
      <div id="feedback" class="alert d-none mt-3 fw-semibold text-center" role="alert"></div>

      <div class="mt-3">
        <a href="{% url 'terminal:terminal_queue' %}" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-list-ul me-1"></i>View Terminal Queue
        </a>
      </div>

      <!-- Hidden CSRF token -->
      <form style="display:none;">{% csrf_token %}</form>
    </div>
  </div>
</div>

<!-- üü¶ html5-qrcode CDN -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
// üü¶ Utility: show feedback without stopping camera
function showFeedback(message, kind = "info") {
  const fb = document.getElementById("feedback");
  fb.className = "alert mt-3 fw-semibold text-center";
  fb.textContent = message;
  fb.classList.remove("d-none");

  fb.classList.remove("alert-success", "alert-danger", "alert-warning", "alert-info");
  if (kind === "success") fb.classList.add("alert-success");
  else if (kind === "danger") fb.classList.add("alert-danger");
  else if (kind === "warning") fb.classList.add("alert-warning");
  else fb.classList.add("alert-info");
}

// üü® POST scanned QR to backend
async function postQRCode(qrCode) {
  try {
    const response = await fetch("{% url 'terminal:qr_scan_entry' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
        "X-Requested-With": "XMLHttpRequest",
      },
      body: new URLSearchParams({ qr_code: qrCode }),
    });

    const data = await response.json();
    if (data.status === "success") {
      showFeedback(data.message, "success");

      // üü¢ Pause scanning briefly to avoid duplicate scans
      scanningPaused = true;
      setTimeout(() => {
        scanningPaused = false;
        showFeedback("‚úÖ Ready for next scan...", "info");
      }, 4000);
    } else {
      // üü• Show specific error and continue scanning
      showFeedback(data.message, "danger");
    }
  } catch (err) {
    showFeedback("Network error ‚Äî please check connection.", "danger");
  }
}

// üü© Initialize camera scanner
const html5QrCode = new Html5Qrcode("qr-reader");
const config = { fps: 10, qrbox: { width: 250, height: 250 } };
let lastScanned = "";
let scanningPaused = false;

html5QrCode.start(
  { facingMode: "environment" },
  config,
  (decodedText) => {
    // prevent duplicate scans of same QR or during pause
    if (scanningPaused || decodedText === lastScanned) return;
    lastScanned = decodedText;
    postQRCode(decodedText);
  },
  (errorMessage) => {
    // ignore minor scan errors to keep camera running
  }
).catch(err => {
  showFeedback("‚ùå Failed to access camera: " + err, "danger");
});
</script>
{% endblock %}
