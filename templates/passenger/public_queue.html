{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Passenger Queue | TicketNow</title>
  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body { background: #f7f9fc; font-family: 'Segoe UI', sans-serif; }
    .hero { background: linear-gradient(135deg,#0d6efd,#6610f2); color: white; padding: 1.8rem; border-radius:0 0 12px 12px; text-align:center; }
    .route-pill { background:#e7f1ff; color:#0d6efd; font-weight:600; padding:4px 10px; border-radius:999px; font-size:.85rem; }
    .countdown { font-weight:700; }
    .progress { height: 10px; border-radius: 12px; background:#e9ecef; overflow:hidden; }
    .progress-bar {
      width:0%;
      height:100%;
      transition: width 1s linear, background-color 0.4s ease;
      will-change: width, background-color;
    }
    .progress-bar.glow { box-shadow: 0 0 10px rgba(220,53,69,0.6); }
    .vehicle-card { border-radius:.8rem; }
    .departed-row { opacity: 0.55; background: #f8f9fa; }
    .departed-label { color:#6c757d; font-weight:700; }
    .countdown-small { font-size:0.95rem; }
    /* Progress color states */
    .progress-blue { background: linear-gradient(90deg,#0d6efd,#0b5ed7); }
    .progress-orange { background: linear-gradient(90deg,#fd7e14,#f76707); }
    .progress-red { background: linear-gradient(90deg,#dc3545,#b02a37); box-shadow: 0 0 8px rgba(220,53,69,0.45); }
  </style>
</head>
<body>

<div class="hero mb-4">
  <h3 class="mb-1"><i class="bi bi-bus-front-fill"></i> Terminal Vehicle Schedule</h3>
  <p class="mb-0">Live departures â€” follow the status and the countdown.</p>
</div>

<div class="container pb-4">
  <form method="get" class="row g-3 justify-content-center mb-4">
    <div class="col-md-4 col-sm-8">
      <select name="route" class="form-select shadow-sm" onchange="this.form.submit()">
        <option value="all">All Routes</option>
        {% for route in routes %}
          <option value="{{ route.id }}" {% if route.id|stringformat:'s' == selected_route %}selected{% endif %}>
            {{ route.origin }} â†’ {{ route.destination }}
          </option>
        {% endfor %}
      </select>
    </div>
  </form>

  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body table-responsive">
      {% if queue_entries %}
      <table class="table align-middle table-hover mb-0">
        <thead class="table-primary">
          <tr>
            <th>#</th>
            <th>Vehicle</th>
            <th>Route</th>
            <th>Driver</th>
            <th>Status</th>
            <th>Departure</th>
            <th>Countdown</th>
          </tr>
        </thead>
        <tbody>
          {% for q in queue_entries %}
          <tr id="row-{{ q.id }}" class="{% if not q.is_active and q.recently_departed %}departed-row{% endif %}">
            <td>{{ forloop.counter }}</td>
            <td><strong>{{ q.vehicle.license_plate }}</strong></td>
            <td><span class="route-pill">{{ q.route }}</span></td>
            <td>{{ q.driver.first_name }} {{ q.driver.last_name }}</td>

            <td>
              {% if q.is_active %}
                <span class="badge bg-success">Boarding</span>
              {% else %}
                <span class="badge bg-secondary">Departed</span>
              {% endif %}
            </td>

            <td>
              {{ q.departure_time|date:"M d, Y h:i A" }}
            </td>

            <td class="text-start" style="min-width:220px;">
              {# We pass departure_time in ISO for JS to parse #}
              {% if departure_duration_minutes|default:30 >= 15 %}
                <div class="d-flex flex-column">
                  <div class="d-flex justify-content-between mb-1">
                    <div class="countdown-small">
                      <span class="countdown" data-departure="{{ q.departure_time|date:'Y-m-d H:i:s' }}"></span>
                    </div>
                    <div class="small text-muted">
                      <span class="countdown-label" data-departure="{{ q.departure_time|date:'Y-m-d H:i:s' }}"></span>
                    </div>
                  </div>
                  <div class="progress">
                    <div class="progress-bar" role="progressbar"
                         style="width:0%"
                         data-departure="{{ q.departure_time|date:'Y-m-d H:i:s' }}"
                         aria-valuemin="0"
                         aria-valuemax="100"></div>
                  </div>
                </div>
              {% else %}
                <div class="small text-muted">Boarding soon</div>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <p class="text-center text-muted my-3">No vehicles currently scheduled for departure.</p>
      {% endif %}
    </div>
  </div>

  <p class="refresh-note mt-4 text-center text-muted">
    <i class="bi bi-arrow-repeat"></i> Auto-refreshing every 15 seconds for live updates
  </p>
</div>

<script>
// Client-side timer & progress logic for passenger view
(function () {
  const serverNowISO = "{{ server_now|date:'Y-m-d H:i:s' }}";
  // calibrate client time with server time
  const serverNow = new Date(serverNowISO.replace(' ', 'T'));
  const clientNow = new Date();
  const timeOffset = serverNow.getTime() - clientNow.getTime(); // add to client time to get server time

  const FIFTEEN_MS = 15 * 60 * 1000;
  const TWO_MIN_MS = 2 * 60 * 1000;
  const DEPARTED_KEEP_MS = 5 * 60 * 1000;

  function nowMs() {
    return Date.now() + timeOffset;
  }

  function formatMinsSecs(ms) {
    if (ms <= 0) return "Departing now!";
    const mins = Math.floor(ms / 60000);
    const secs = Math.floor((ms % 60000) / 1000);
    if (mins > 0) return `${mins} min${mins !== 1 ? 's' : ''} ${secs}s`;
    return `${secs}s`;
  }

  function updateAll() {
    document.querySelectorAll('.countdown').forEach(span => {
      const depart = new Date(span.dataset.departure.replace(' ', 'T')).getTime();
      const diff = depart - nowMs();

      // if admin set less than 15 min in view, the progress/countdown hidden by template.
      if (diff <= 0) {
        span.textContent = "ðŸš Departing now!";
      } else if (diff > FIFTEEN_MS) {
        // not yet within the 15 min countdown window
        span.textContent = "â€”";
      } else {
        // within 15 min window
        const mins = Math.floor(diff / 60000);
        span.textContent = `â³ Leaves in ${mins} min${mins !== 1 ? 's' : ''}`;
      }
    });

    // update progress bars (smooth)
    document.querySelectorAll('.progress-bar').forEach(bar => {
      const depart = new Date(bar.dataset.departure.replace(' ', 'T')).getTime();
      const diff = depart - nowMs();

      if (diff <= 0) {
        bar.style.width = "100%";
        bar.classList.remove('progress-blue', 'progress-orange');
        bar.classList.add('progress-red', 'glow');
      } else if (diff > FIFTEEN_MS) {
        // no progress yet
        bar.style.width = "0%";
        bar.classList.remove('progress-red', 'progress-orange', 'glow');
        bar.classList.add('progress-blue');
      } else {
        // percent elapsed within 15-minute window
        const elapsed = FIFTEEN_MS - diff;
        const pct = Math.min(100, Math.max(0, (elapsed / FIFTEEN_MS) * 100));
        bar.style.width = pct + "%";

        // color stages
        if (pct < 50) {
          bar.classList.remove('progress-orange', 'progress-red', 'glow');
          bar.classList.add('progress-blue');
        } else if (pct < 85) {
          bar.classList.remove('progress-blue', 'progress-red', 'glow');
          bar.classList.add('progress-orange');
        } else {
          bar.classList.remove('progress-blue', 'progress-orange');
          bar.classList.add('progress-red', 'glow');
        }
      }
    });

    // remove rows that are departed for more than 5 minutes (client-side)
    document.querySelectorAll('tr[id^="row-"]').forEach(row => {
      if (row.classList.contains('departed-row')) {
        // determine when it departed: find departure_time cell text as date string is still available in data attributes
        const pb = row.querySelector('.progress-bar, .countdown');
        if (!pb) return; // skip if no data
        const departAttr = pb.dataset.departure;
        if (!departAttr) return;
        const departTime = new Date(departAttr.replace(' ', 'T')).getTime();
        // we need to find actual departed_at time; we can't get exact departed_at here,
        // so we remove row if current time is > (departure_time + 5 minutes)
        if (nowMs() - departTime > (FIFTEEN_MS + DEPARTED_KEEP_MS)) {
          // beyond expected departure + keep window => remove
          row.remove();
        }
      }
    });
  }

  // Initial update + smooth interval every second
  updateAll();
  setInterval(updateAll, 1000);

  // Auto refresh the page data every 15s (lighter than full reload â€” just reload whole page)
  setInterval(() => {
    // optimistic partial reload: reload the entire page to fetch server-side changes
    location.reload();
  }, 15000);
})();
</script>

</body>
</html>
