{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Passenger Queue | TicketNow</title>

  <link rel="icon" type="image/png" href="{% static 'img/TicketNow-Logo.png' %}">
  <link rel="shortcut icon" href="{% static 'img/TicketNow-Logo.png' %}">

  <!-- Bootstrap + Icons -->
  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .route-pill {
      background: #e7f1ff;
      color: #0d6efd;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: .85rem;
    }

    .status-boarding {
      background-color: #28a745;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .status-departed {
      background-color: #6c757d;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .countdown-now {
      background-color: #dc3545;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .countdown-soon {
      background-color: #fd7e14;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .countdown-waiting {
      background-color: transparent;
      color: #6c757d;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .progress {
      height: 6px;
    }

    .progress-bar {
      transition: width 0.8s linear;
      height: 6px;
    }

    .progress-blue { background: #0d6efd; }
    .progress-orange { background: #fd7e14; }
    .progress-red { background: #dc3545; }

    .departed-row {
      opacity: 0.55;
      background: #f8f9fa !important;
    }

    .refresh-note {
      font-size: 0.85rem;
      color: #6c757d;
    }
  </style>
</head>

<body>

<div class="container py-4">

  <!-- Back to Home Button -->
  <div class="mb-4">
    <a href="{% url 'passenger:home' %}" class="btn btn-outline-primary">
      <i class="bi bi-arrow-left-circle-fill me-1"></i> Back to Home
    </a>
  </div>

  <!-- Title -->
  <div class="d-flex align-items-center mb-3">
    <img src="{% static 'img/TicketNow-Logo.png' %}" alt="TicketNow Logo" width="80" height="80" class="me-2">
    <h2 class="fw-bold mb-0">Terminal Vehicle Schedule</h2>
  </div>

  <!-- Route Filter -->
  <form method="get" class="row g-3 mb-3" style="max-width: 360px;">
    <div class="col-12">
      <label class="form-label fw-semibold">Filter by Route</label>
      <select name="route" class="form-select" onchange="this.form.submit()">
        <option value="all">All Routes</option>
        {% for route in routes %}
          <option value="{{ route.id }}" {% if route.id|stringformat:'s' == selected_route %}selected{% endif %}>
            {{ route.origin }} → {{ route.destination }}
          </option>
        {% endfor %}
      </select>
    </div>
  </form>

  <!-- Schedule Table -->
  <div class="table-responsive shadow-sm border rounded bg-white">
    {% if queue_entries %}
    <table class="table table-bordered align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Vehicle</th>
          <th>Route</th>
          <th>Driver</th>
          <th>Status</th>
          <th>Departure</th>
          <th>Countdown</th>
        </tr>
      </thead>

      <tbody>
        {% for q in queue_entries %}
        <tr id="row-{{ q.id }}" class="{% if not q.is_active %}departed-row{% endif %}">
          <td>{{ forloop.counter }}</td>

          <td><strong>{{ q.vehicle.license_plate }}</strong></td>

          <td>
            <span class="route-pill">{{ q.route }}</span>
          </td>

          <td>{{ q.driver.first_name }} {{ q.driver.last_name }}</td>

          <td>
            {% if q.is_active %}
              <span class="status-boarding">Boarding</span>
            {% else %}
              <span class="status-departed">
                {% if q.recently_departed %}
                  Departed
                {% else %}
                  Closed
                {% endif %}
              </span>
            {% endif %}
          </td>

          <td>{{ q.departure_time|date:"M d, Y h:i A" }}</td>

          <td style="min-width: 220px;">
            {% if q.is_active %}
              <div class="mb-1">
                <span class="countdown"
                  data-departure="{{ q.departure_time|date:'Y-m-d H:i:s' }}"></span>
              </div>

              <div class="progress">
                <div class="progress-bar progress-blue"
                  data-departure="{{ q.departure_time|date:'Y-m-d H:i:s' }}"></div>
              </div>
            {% else %}
              <span class="text-muted small">—</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% else %}
      <p class="text-center text-muted py-3 mb-0">
        No vehicles currently scheduled for departure.
      </p>
    {% endif %}
  </div>

  <p class="refresh-note text-end mt-3">
    <i class="bi bi-arrow-repeat me-1"></i>
    Auto-refreshing every 15 seconds for live updates.
  </p>

</div>

<!-- JS Countdown + Progress -->
<script>
(function () {
  // Server-supplied reference now (ISO-like string)
  const serverNowISO = "{{ server_now|date:'Y-m-d H:i:s' }}";
  const serverNow = new Date(serverNowISO.replace(' ', 'T'));
  const clientNow = new Date();
  const timeOffset = serverNow.getTime() - clientNow.getTime();

  // fixed countdown window before departure (15 minutes)
  const COUNTDOWN_MIN = 15;
  const COUNTDOWN_MS = COUNTDOWN_MIN * 60 * 1000;

  function nowMs() {
    return Date.now() + timeOffset;
  }

  function updateAll() {
    // Countdown text logic
    document.querySelectorAll('.countdown').forEach(span => {
      const row = span.closest("tr");

      // If closed/departed → show dash and skip
      if (row.classList.contains("departed-row")) {
        span.innerHTML = '<span class="countdown-waiting">—</span>';
        return;
      }

      const depart = new Date(span.dataset.departure.replace(' ', 'T')).getTime();
      const diff = depart - nowMs(); // milliseconds until departure

      if (diff <= 0) {
        // departure has arrived
        span.innerHTML = '<span class="countdown-now">Departing now!</span>';
      } else if (diff > COUNTDOWN_MS) {
        // outside countdown window: show "Waiting"
        span.innerHTML = '<span class="countdown-waiting">Waiting</span>';
      } else {
        // inside last COUNTDOWN_MIN minutes: show countdown
        const mins = Math.ceil(diff / 60000);
        span.innerHTML = `<span class="countdown-soon">Leaves in ${mins} min</span>`;
      }
    });

    // Progress bars reflect countdown window (0% before window, progress during last 15 min)
    document.querySelectorAll('.progress-bar').forEach(bar => {
      const row = bar.closest("tr");

      if (row.classList.contains("departed-row")) {
        bar.style.width = "0%";
        bar.classList.remove('progress-blue', 'progress-orange', 'progress-red');
        return;
      }

      const depart = new Date(bar.dataset.departure.replace(' ', 'T')).getTime();
      const diff = depart - nowMs();

      if (diff <= 0) {
        // fully departed
        bar.style.width = "100%";
        bar.classList.remove('progress-blue', 'progress-orange');
        bar.classList.add('progress-red');
      } else if (diff > COUNTDOWN_MS) {
        // before countdown window
        bar.style.width = "0%";
        bar.classList.remove('progress-orange', 'progress-red');
        bar.classList.add('progress-blue');
      } else {
        // during countdown: pct is fraction of 15-min elapsed
        const pct = ((COUNTDOWN_MS - diff) / COUNTDOWN_MS) * 100;
        bar.style.width = pct + "%";

        if (pct < 50) {
          bar.classList.remove('progress-orange', 'progress-red');
          bar.classList.add('progress-blue');
        } else if (pct < 85) {
          bar.classList.remove('progress-blue', 'progress-red');
          bar.classList.add('progress-orange');
        } else {
          bar.classList.remove('progress-blue', 'progress-orange');
          bar.classList.add('progress-red');
        }
      }
    });
  }

  updateAll();
  setInterval(updateAll, 1000);
  setInterval(() => location.reload(), 15000);
})();
</script>

</body>
</html>
